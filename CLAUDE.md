# SMRM - シンプルカルテ管理

個人サロン・治療院（マッサージ・整体・鍼灸・エステ等）向けのブラウザ完結型カルテ管理アプリケーション。

## 開発コマンド

```bash
# Docker ビルド＆起動（ポート 8085）
bash scripts/build.sh

# 強制リビルド
bash scripts/rebuild.sh

# ユニットテスト
npm test

# E2Eテスト（Docker内で実行）
docker compose run --rm smrm-test
```

## コーディング規約

- `smrm.calc.js` には純粋関数のみ（DOM操作・IndexedDB操作禁止）
- `script.js` にUI操作・DB操作を集約
- 外部ライブラリ追加禁止（vanilla JSのみ）
- HTML特殊文字は必ず `escapeHtml()` でエスケープ

# Commit Message Guidelines
- コミットメッセージは常に日本語で記述してください。
- 変更内容を具体的かつ詳細に記述してください。
- 箇条書き（- ）を使用して、複数の変更点を明確にリストアップしてください。
- 変更の種類を判定して、プレフィックスをつけてください。 例： docs:
  - `feat:` - 新機能の追加
  - `fix:` - バグ修正
  - `docs:` - ドキュメントの変更
  - `style:` - コードフォーマット、セミコロンなどのスタイル変更
  - `refactor:` - リファクタリング（機能変更なし）
  - `perf:` - パフォーマンス改善
  - `test:` - テストの追加・修正
  - `chore:` - ビルドプロセス、補助ツールの変更
 - 注意事項
   - 大きな変更がある場合は、複数のコミットに分割することを提案してください

# ワークフロー設計

### 1. Planモードを基本とする
- 3ステップ以上 or アーキテクチャに関わるタスクは必ずPlanモードで開始する
- 途中でうまくいかなくなったら、無理に進めずすぐに立ち止まって再計画する
- 構築だけでなく、検証ステップにもPlanモードを使う
- 曖昧さを減らすため、実装前に詳細な仕様を書く

### 2. サブエージェント戦略
- メインのコンテキストウィンドウをクリーンに保つためにサブエージェントを積極的に活用する
- リサーチ・調査・並列分析はサブエージェントに任せる
- 複雑な問題には、サブエージェントを使ってより多くの計算リソースを投入する
- 集中して実行するために、サブエージェント1つにつき1タスクを割り当てる

### 3. 自己改善ループ
- ユーザーから修正を受けたら必ず `tasks/lessons.md` にそのパターンを記録する
- 同じミスを繰り返さないように、自分へのルールを書く
- ミス率が下がるまで、ルールを徹底的に改善し続ける
- セッション開始時に、そのプロジェクトに関連するlessonsをレビューする

### 4. 完了前に必ず検証する
- 動作を証明できるまで、タスクを完了とマークしない
- 必要に応じてmainブランチと自分の変更の差分を確認する
- 「スタッフエンジニアはこれを承認するか？」と自問する
- テストを実行し、ログを確認し、正しく動作することを示す

### 5. エレガントさを追求する（バランスよく）
- 重要な変更をする前に「もっとエレガントな方法はないか？」と一度立ち止まる
- ハック的な修正に感じたら「今知っていることをすべて踏まえて、エレガントな解決策を実装する」
- シンプルで明白な修正にはこのプロセスをスキップする（過剰設計しない）
- 提示する前に自分の作業に自問自答する

### 6. 自律的なバグ修正
- バグレポートを受けたら、手取り足取り教えてもらわずにそのまま修正する
- ログ・エラー・失敗しているテストを見て、自分で解決する
- ユーザーのコンテキスト切り替えをゼロにする
- 言われなくても、失敗しているCIテストを修正しに行く

---

## タスク管理

1. **まず計画を立てる**：チェック可能な項目として `tasks/todo.md` に計画を書く
2. **計画を確認する**：実装を開始する前に確認する
3. **進捗を記録する**：完了した項目を随時マークしていく
4. **変更を説明する**：各ステップで高レベルのサマリーを提供する
5. **結果をドキュメント化する**：`tasks/todo.md` にレビューセクションを追加する
6. **学びを記録する**：修正を受けた後に `tasks/lessons.md` を更新する

---

## コア原則

- **シンプル第一**：すべての変更をできる限りシンプルにする。影響するコードを最小限にする。
- **手を抜かない**：根本原因を見つける。一時的な修正は避ける。シニアエンジニアの水準を保つ。
- **影響を最小化する**：変更は必要な箇所のみにとどめる。バグを新たに引き込まない。
