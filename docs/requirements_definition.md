# 要件定義書 — シンプルカルテ管理 (smrm)

## 1. はじめに

### 1.1 目的

本書は、個人サロン・治療院（マッサージ・整体・鍼灸・エステ等）向けブラウザ完結型カルテ管理アプリケーション「シンプルカルテ管理（smrm）」の要件を定義する。

### 1.2 背景

小規模な個人サロン・治療院では、紙カルテによる顧客管理が主流であり、以下の課題がある。

- 顧客情報の検索に時間がかかる
- カルテの紛失・劣化リスク
- 情報の共有・バックアップが困難
- 来店履歴の把握に手間がかかる

一方、既存の電子カルテシステムは高額な導入コスト・月額費用が障壁となり、小規模施術院での導入が進んでいない。

### 1.3 対象ユーザー

- 個人経営のマッサージ院・整体院・鍼灸院・エステサロン
- スタッフ1〜5名程度の小規模施術院
- ITリテラシーが標準的な施術者

---

## 2. システム概要

ブラウザ上で動作する SPA（Single Page Application）として実装し、すべてのデータをブラウザ内の IndexedDB に保存する。サーバーサイドの処理は不要であり、静的ファイルの配信のみで運用可能とする。

- **動作環境**: モダンブラウザ（Chrome, Firefox, Safari, Edge）
- **データ保存先**: ブラウザ内 IndexedDB
- **ネットワーク**: オフラインでも完全動作（PWA対応）
- **デプロイ**: Docker + nginx による静的ファイル配信

---

## 3. 機能要件

### 3.1 顧客管理機能

#### 入力項目

| フィールド | 型 | 必須 | バリデーション |
|-----------|-----|------|-------------|
| 氏名 | string | ○ | 1〜100文字 |
| ふりがな | string | | ひらがな+長音記号+スペースのみ、100文字以内 |
| 生年月日 | date | | 過去日付、0〜150歳 |
| 性別 | enum | | male / female / other |
| 電話番号 | string | | 半角数字+ハイフン、7〜15文字 |
| メールアドレス | string | | email形式 |
| 住所 | string | | |
| 職業 | string | | |
| 紹介元 | string | | |
| 来店動機 | string | | |
| 初回来店日 | date | | |
| 担当施術者 | string | | |
| 備考 | string | | |
| アレルギー情報 | array | | アレルゲン名・重症度・備考 |
| 既往歴 | array | | 疾患名・備考 |
| 写真 | media[] | | 最大5枚 |

#### 機能

- 顧客の新規登録・編集・削除
- 顧客コード自動採番（C0001〜C9999）
- 顧客一覧表示
- 顧客検索（氏名・ふりがな・顧客コードで部分一致）
- 年齢自動計算（生年月日から）
- 顧客詳細の読み取り専用表示（オーバーレイ）
- 写真未登録時の顧客イニシャル表示（顧客カード）

#### 顧客詳細表示

顧客情報を読み取り専用のオーバーレイで表示する機能。施術中でもワンタップで顧客情報を確認できる。

**アクセスポイント**

| # | トリガー | 場所 |
|---|---------|------|
| 1 | 顧客カードの「詳細」ボタン | 顧客タブ |
| 2 | 顧客情報バーのクリック | 施術記録タブ |
| 3 | 顧客情報バーのクリック | 履歴タブ |

**表示セクション**

| # | セクション | 内容 |
|---|-----------|------|
| 1 | 基本情報 | 顧客コード、氏名、ふりがな、生年月日（年齢）、性別 |
| 2 | 連絡先 | 電話番号、メール、住所 |
| 3 | 来店情報 | 職業、紹介元、来店動機、初回来店日、担当施術者 |
| 4 | 備考 | 備考テキスト |
| 5 | アレルギー情報 | アレルゲン名・重症度・備考の一覧 |
| 6 | 既往歴 | 疾患名・備考の一覧 |
| 7 | 写真 | 登録済み写真のサムネイル一覧 |
| 8 | メタ情報 | 登録日、更新日 |

**操作ボタン**

| ボタン | 動作 |
|-------|------|
| 閉じる | オーバーレイを閉じる |
| 編集 | オーバーレイを閉じて顧客編集モーダルを開く |

#### 保存先

IndexedDB `customers` ストア（keyPath: `id`）

---

### 3.2 施術記録機能

#### 入力項目

| フィールド | 型 | 必須 | バリデーション |
|-----------|-----|------|-------------|
| 来店日時 | datetime | | デフォルト:現在日時 |
| 主訴 | string | △ | 2000文字以内 |
| 所見 | string | △ | 2000文字以内 |
| 施術内容 | string | △ | 2000文字以内 |
| 施術後メモ・次回予定 | string | △ | 2000文字以内 |
| 施術メニュー | select | | メニューマスタから選択 |
| 施術時間（分） | number | | 1〜480 |
| 写真 | media[] | | 最大5枚 |

△: 主訴/所見/施術内容/施術後メモのいずれか1つ以上が必須

#### 機能

- 施術記録の新規作成・編集・削除
- 顧客選択に連動した記録入力
- 前回施術後メモのヒント表示
- 直近の記録サマリー表示

#### 保存先

IndexedDB `treatment_records` ストア（keyPath: `id`）

---

### 3.3 施術メニュー管理機能

#### 入力項目

| フィールド | 型 | 必須 | バリデーション |
|-----------|-----|------|-------------|
| メニュー名 | string | ○ | 1〜100文字 |
| デフォルト施術時間（分） | number | | 1〜480の整数 |

#### 機能

- メニューの追加・編集・削除
- 表示順（sortOrder）による並び替え
- 施術記録入力時のドロップダウン選択
- メニュー選択時にデフォルト時間を自動入力
- インポート時のメニューマージ（名前ベースで重複スキップ）

#### 保存先

IndexedDB `app_settings` ストア（id: `treatment_menus`）

---

### 3.4 メディア（写真）管理機能

#### 仕様

| 項目 | 値 |
|------|-----|
| 最大枚数 | 1レコードあたり5枚 |
| 入力方法 | ファイル選択 / ドラッグ&ドロップ |
| 出力形式 | JPEG自動変換 |
| リサイズ | 長辺を設定値以下に縮小 |
| サムネイル | 長辺200px、JPEG品質0.6 |

#### 機能

- 画像ファイルの添付（顧客・施術記録）
- ドラッグ&ドロップによるアップロード
- サムネイル表示
- ライトボックスによる拡大表示
- 個別削除

#### 保存先

IndexedDB `media` ストア（keyPath: `id`）

---

### 3.5 アレルギー・既往歴管理機能

#### アレルギー入力項目

| フィールド | 型 | 必須 |
|-----------|-----|------|
| アレルゲン名 | string | ○ |
| 重症度 | enum | | (mild / moderate / severe) |
| 備考 | string | |

#### 既往歴入力項目

| フィールド | 型 | 必須 |
|-----------|-----|------|
| 疾患名 | string | ○ |
| 備考 | string | |

#### 機能

- 動的な行追加・削除
- 施術記録タブでのアレルギー警告表示（アレルギー情報がある顧客を選択した際に警告バーを表示）
- 顧客登録フォーム内で管理

---

### 3.6 タイムライン表示機能

#### 体調レベル入力項目

| フィールド | 型 | 範囲 |
|-----------|-----|------|
| 痛みレベル | integer | 0〜10 |
| 凝りレベル | integer | 0〜10 |
| 疲労レベル | integer | 0〜10 |
| 気になる部位 | array | 16部位から複数選択 |
| 体調メモ | string | |

#### 選択可能部位

首、右肩、左肩、背中上部、背中下部、腰、右腕、左腕、右脚、左脚、頭、目、お腹、股関節、膝、足首・足裏

#### 機能

- 顧客ごとの施術記録を時系列で表示
- 新しい順/古い順の並び替え
- ページネーション（20件/ページ）
- 各記録の詳細表示（主訴・所見・施術内容・施術後メモ・体調レベル・写真）

---

### 3.7 データエクスポート/インポート機能

#### エクスポート

- 全データ（顧客・施術記録・メディア・施術メニュー・表示設定）をJSON形式でダウンロード
- ファイル名: `smrm_backup_YYYYMMDD_HHMMSS.json`

#### インポート

- JSONファイルをアップロードしてデータを復元
- `appName: 'smrm'` によるフォーマット検証
- 既存データとのマージ（同一IDはスキップ）
- 施術メニューは名前ベースでマージ

#### 全データ削除

- 確認ダイアログ表示後、全ストアをクリア

---

### 3.8 表示設定機能

#### 設定可能フィールド

**顧客情報フィールド（12項目）**

顧客コード、ふりがな、電話番号、メールアドレス、住所、職業、初回来店日、担当施術者、備考、アレルギー情報、既往歴、写真添付

**施術記録フィールド（4項目）**

施術メニュー、施術時間、体調レベル、写真添付

#### 機能

- チェックボックスによるフィールドの表示/非表示切り替え
- 設定変更は即座にUIに反映
- 設定は IndexedDB `app_settings` ストアに永続化

---

### 3.9 画像圧縮設定機能

#### プリセット

| プリセット名 | 長辺(px) | JPEG品質 | 目安サイズ |
|-------------|---------|----------|-----------|
| 高画質 | 2048 | 0.92 | 300〜800KB/枚 |
| 標準（デフォルト） | 1200 | 0.80 | 100〜400KB/枚 |
| 容量節約 | 800 | 0.60 | 50〜200KB/枚 |

#### 機能

- ドロップダウンによるプリセット選択
- プリセット変更時のヒント表示
- 設定は新規添付写真にのみ適用（既存写真は変更されない）

---

### 3.10 固定UI要素

| 要素 | 位置 | 機能 |
|------|------|------|
| スクロールトップボタン | 左上固定 | ページ先頭へスクロール |
| バージョン情報 | 右上固定 | アプリバージョン・ビルド日時を表示 |
| ヘッダー | 上部 | タイトル表示、クリックでページ先頭へ |
| 更新バナー | ヘッダー直下 | 新バージョン検知時に表示 |

---

### 3.11 PWA対応

| 機能 | 仕様 |
|------|------|
| オフライン動作 | Service Worker によるアセットキャッシュ |
| ホーム画面追加 | Web App Manifest 対応 |
| スタンドアロン表示 | `display: standalone` |
| 更新通知 | 新 Service Worker 検知時にバナー表示 |
| 手動更新確認 | 設定タブの「更新を確認」ボタン |
| テーマカラー | `#92400e` |

---

## 4. 非機能要件

### 4.1 パフォーマンス

- 顧客100人、施術記録10,000件でもスムーズに動作すること
- 画像添付時のリサイズは非同期で処理し、UIをブロックしないこと

### 4.2 セキュリティ

- HTML特殊文字は必ず `escapeHtml()` でエスケープし、XSSを防止すること
- データはブラウザ内に保存し、外部サーバーへの送信は一切行わないこと

### 4.3 ユーザビリティ

- レスポンシブデザイン（モバイル375px〜デスクトップ1280px+）
- 顧客切り替え時のフォームリセット
- 入力補助（前回施術後メモのヒント表示、メニュー選択時のデフォルト時間自動入力）

### 4.4 可用性

- オフライン環境でも全機能が利用可能であること
- ブラウザのみで動作し、プラグインやネイティブアプリが不要であること

### 4.5 データ保全

- JSON形式によるエクスポート/インポートでデータバックアップが可能であること
- インポート時にデータ形式を検証し、不正データを拒否すること

### 4.6 互換性

- Chrome, Firefox, Safari, Edge の最新版で動作すること
- iOS Safari での PWA 動作に対応すること（apple-mobile-web-app-capable）
